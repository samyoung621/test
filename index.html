<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>球員成績表（含照片）</title>
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.8/css/jquery.dataTables.min.css">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    h1 { margin-bottom: 16px; }
    .table-container { overflow-x: auto; }
    table.dataTable thead th {
      position: sticky; top: 0; background: #f3f4f6; z-index: 3;
    }
    td.num, th.num { text-align: right; }
    td.photo img { width: 72px; height: auto; border-radius: 4px; }
    td.sticky, th.sticky {
      position: sticky; left: 0; background: white; z-index: 2;
    }
    td.sticky2, th.sticky2 {
      position: sticky; left: 80px; background: white; z-index: 2;
    }
  </style>
</head>
<body>
  <h1>球員成績表（含照片）</h1>
  <div class="table-container">
    <table id="stats" class="display" style="width:100%">
      <thead></thead>
      <tbody></tbody>
      <tfoot></tfoot>
    </table>
  </div>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.8/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQG-3TToygmpU9ISirmKzyTHEtFdvP9OUpFRSpB-kzPQCNYlkywx1XEHOqcVwhOdibujEhds8sl1Sim/pub?output=csv";

    Papa.parse(CSV_URL, {
      download: true,
      header: true,
      complete: function(parsed) {
        const data = parsed.data.filter(r => r["背號"] && r["姓名"]);
        if (!data.length) { alert("CSV 無資料或讀取失敗"); return; }

        let headers = parsed.meta.fields;

        if (!headers.includes("OPS") && headers.includes("上壘率") && headers.includes("長打率")) {
          headers.push("OPS");
          data.forEach(r => {
            r["OPS"] = (parseFloat(r["上壘率"]) + parseFloat(r["長打率"])).toFixed(3);
          });
        }

        const finalHeaders = ["背號","照片","姓名", ...headers.filter(h => !["背號","照片","姓名"].includes(h))];
        const thead = $("<thead><tr></tr></thead>").appendTo("#stats");
        finalHeaders.forEach((h,idx) => {
          const th = $("<th></th>").text(h);
          if (h==="背號") th.addClass("sticky");
          if (h==="姓名") th.addClass("sticky2");
          thead.find("tr").append(th);
        });

        const tbody = $("<tbody></tbody>").appendTo("#stats");
        data.forEach(r => {
          const tr = $("<tr></tr>").appendTo(tbody);
          finalHeaders.forEach(h => {
            const td = $("<td></td>").appendTo(tr);
            if (h==="照片") {
              td.addClass("photo").html(`<img src="${r[h]}" alt="${r["姓名"]}" onerror="this.onerror=null;this.replaceWith('No Image');">`);
            } else {
              const val = r[h] || "";
              td.text(val);
              if (!isNaN(val)) td.addClass("num");
            }
            if (h==="背號") td.addClass("sticky");
            if (h==="姓名") td.addClass("sticky2");
          });
        });

        const tfoot = $("<tfoot><tr></tr></tfoot>").appendTo("#stats");
        finalHeaders.forEach(h => {
          const td = $("<td></td>").appendTo(tfoot.find("tr"));
          if (h==="背號" || h==="姓名" || h==="照片") {
            td.text("");
          } else {
            const vals = data.map(r => parseFloat(r[h])).filter(v => !isNaN(v));
            td.text(vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(3) : "").addClass("num");
          }
        });

        $("#stats").DataTable({
          paging: false,
          info: false,
          scrollX: true,
          order: []
        });
      }
    });
  </script>
</body>
</html>
