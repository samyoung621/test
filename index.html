
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <title>çƒå“¡æˆç¸¾è¡¨ï¼ˆå«ç…§ç‰‡ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root {
      --sticky-w1: 70px;   /* èƒŒè™Ÿæ¬„å¯¬ */
      --sticky-w2: 90px;   /* ç…§ç‰‡æ¬„å¯¬ */
      --sticky-w3: 140px;  /* å§“åæ¬„å¯¬ */
    }
    body { font-family: ui-sans-serif, system-ui, -apple-system, "PingFang TC", "Noto Sans TC", Arial; margin: 18px; }
    h1 { margin: 6px 0 14px; }
    .toolbar { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .search { padding:8px 10px; border:1px solid #ccc; border-radius:8px; min-width:220px; }
    table { border-collapse: collapse; width: 100%; overflow-x: auto; display:block; }
    th, td { border:1px solid #e5e7eb; padding:8px 10px; white-space:nowrap; text-align:center; background:#fff; }
    thead th { position: sticky; top: 0; z-index: 3; background:#f3f4f6; cursor: pointer; }
    /* å‡çµå‰ä¸‰æ¬„ï¼šèƒŒè™Ÿã€ç…§ç‰‡ã€å§“å */
    tbody td:nth-child(1), thead th:nth-child(1), tfoot td:nth-child(1) { position: sticky; left: 0; z-index: 2; min-width:var(--sticky-w1); }
    tbody td:nth-child(2), thead th:nth-child(2), tfoot td:nth-child(2) { position: sticky; left: var(--sticky-w1); z-index: 2; min-width:var(--sticky-w2); }
    tbody td:nth-child(3), thead th:nth-child(3), tfoot td:nth-child(3) { position: sticky; left: calc(var(--sticky-w1) + var(--sticky-w2)); z-index: 2; min-width:var(--sticky-w3); }
    tfoot td { background:#fafafa; font-weight:700; }
    .photo img { width:56px; height:56px; object-fit:cover; border-radius:8px; display:block; margin:auto; }
    .photo .ph { width:56px; height:56px; display:flex; align-items:center; justify-content:center; background:#f3f4f6; color:#9ca3af; border-radius:8px; font-size:12px; }
    .sort-ind { font-size: 10px; opacity:.65; margin-left:6px; }
  </style>
</head>
<body>
  <h1>çƒå“¡æˆç¸¾è¡¨ï¼ˆå«ç…§ç‰‡ï¼‰</h1>
  <div class="toolbar">
    <input id="q" class="search" placeholder="ğŸ” è¼¸å…¥èƒŒè™Ÿæˆ–å§“åæœå°‹" />
    <span id="status"></span>
  </div>
  <div style="margin-top:10px;">
    <table id="tbl"></table>
  </div>

<script>
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQG-3TToygmpU9ISirmKzyTHEtFdvP9OUpFRSpB-kzPQCNYlkywx1XEHOqcVwhOdibujEhds8sl1Sim/pub?output=csv" + "&v=" + Date.now(); // åŠ ä¸Šæ™‚é–“æˆ³é¿å…å¿«å–

// å˜—è©¦å°‡ Google Drive åˆ†äº«é€£çµè½‰ç‚ºå¯ç›´é€£åœ–ç‰‡é€£çµ
function normalizeImageUrl(url) {
  if (!url) return "";
  try {
    const u = new URL(url);
    // Google Drive: https://drive.google.com/file/d/FILE_ID/view?usp=sharing
    if (u.hostname.includes("drive.google.com")) {
      const m = url.match(/\/d\/([^/]+)\//);
      const id = m ? m[1] : (u.searchParams.get("id") || "");
      if (id) return `https://drive.google.com/uc?export=view&id=${id}`;
    }
    // GitHub raw or Imgur ç›´æ¥å›å‚³
    return url;
  } catch(e) { return url; }
}

function isNumeric(x) {
  return x !== null && x !== "" && !isNaN(parseFloat(x));
}

Papa.parse(CSV_URL, {
  download: true,
  header: true,
  complete: (res) => {
    let data = res.data.filter(r => (r["å§“å"] || r["åå­—"] || r["Name"]) && Object.keys(r).length > 1);

    if (!data.length) {
      document.getElementById("status").textContent = "âŒ è¼‰å…¥åˆ° 0 ç­†è³‡æ–™ï¼Œè«‹ç¢ºèª CSV æ¬„ä½è¡Œé¦–æ˜¯å¦ç‚ºæ¨™é¡Œåˆ—ï¼Œä¸”å·²ç™¼ä½ˆã€‚";
      return;
    }
    document.getElementById("status").textContent = `âœ… å·²è¼‰å…¥ ${data.length} ç­†è³‡æ–™`;

    // å¦‚æœæ²’æœ‰ OPS æ¬„ï¼Œä½†æœ‰ã€Œä¸Šå£˜ç‡ã€ã€Œé•·æ‰“ç‡ã€ï¼Œè‡ªå‹•è¨ˆç®—
    data = data.map(row => {
      const obp = parseFloat(row["ä¸Šå£˜ç‡"]);
      const slg = parseFloat(row["é•·æ‰“ç‡"]);
      if (!row["OPS"] && isNumeric(obp) && isNumeric(slg)) {
        row["OPS"] = (obp + slg).toFixed(3);
      }
      return row;
    });

    const table = document.getElementById("tbl");
    const headers = Object.keys(data[0]);

    // å°‡ã€ŒèƒŒè™Ÿ/ç…§ç‰‡/å§“åã€èª¿æ•´åˆ°å‰ä¸‰æ¬„ï¼ˆè‹¥å­˜åœ¨ï¼‰
    const wantedOrder = ["èƒŒè™Ÿ","ç…§ç‰‡","å§“å"];
    const others = headers.filter(h => !wantedOrder.includes(h));
    const finalHeaders = wantedOrder.filter(h => headers.includes(h)).concat(others);

    const thead = document.createElement("thead");
    const hr = document.createElement("tr");
    finalHeaders.forEach((h, idx) => {
      const th = document.createElement("th");
      th.textContent = h;
      const ind = document.createElement("span");
      ind.className = "sort-ind";
      th.appendChild(ind);
      th.addEventListener("click", () => sortBy(idx, th));
      hr.appendChild(th);
    });
    thead.appendChild(hr);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    function renderRows(rows) {
      tbody.innerHTML = "";
      rows.forEach(r => {
        const tr = document.createElement("tr");
        finalHeaders.forEach(h => {
          const td = document.createElement("td");
          if (h === "ç…§ç‰‡") {
            td.className = "photo";
            const src = normalizeImageUrl(r[h]);
            if (src) {
              td.innerHTML = `<img loading="lazy" referrerpolicy="no-referrer" src="${src}" alt="photo" onerror="this.replaceWith(Object.assign(document.createElement('div'),{className:'ph',innerText:'No Image'}))" />`;
            } else {
              td.innerHTML = '<div class="ph">No Image</div>';
            }
          } else {
            td.textContent = r[h] ?? "";
          }
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }
    renderRows(data);
    table.appendChild(tbody);

    // å¹³å‡åˆ—ï¼ˆåƒ…å°æ•¸å€¼æ¬„è¨ˆç®—ï¼‰
    const tfoot = document.createElement("tfoot");
    const avgTr = document.createElement("tr");
    finalHeaders.forEach((h, i) => {
      const td = document.createElement("td");
      if (i === 0) td.textContent = "å¹³å‡";
      else if (h === "ç…§ç‰‡" || h === "å§“å") td.textContent = "";
      else {
        const nums = data.map(r => parseFloat(r[h])).filter(v => !isNaN(v));
        td.textContent = nums.length ? (nums.reduce((a,b)=>a+b,0)/nums.length).toFixed(3) : "";
      }
      avgTr.appendChild(td);
    });
    tfoot.appendChild(avgTr);
    table.appendChild(tfoot);

    // æœå°‹ï¼ˆèƒŒè™Ÿ/å§“åï¼‰
    document.getElementById("q").addEventListener("input", function() {
      const v = this.value.trim().toLowerCase();
      const rows = Array.from(tbody.rows);
      rows.forEach(row => {
        const id = (row.cells[0]?.textContent || "").toLowerCase();
        const name = (row.cells[2]?.textContent || row.cells[1]?.textContent || "").toLowerCase();
        row.style.display = (id.includes(v) || name.includes(v)) ? "" : "none";
      });
    });

    // æ¬„ä½æ’åº
    let sortState = { index: -1, dir: 1 };
    function sortBy(index, thEl) {
      const label = finalHeaders[index];
      const rows = Array.from(tbody.rows);
      const dir = (sortState.index === index) ? -sortState.dir : 1;
      sortState = { index, dir };

      rows.sort((a,b) => {
        let x = a.cells[index].textContent.trim();
        let y = b.cells[index].textContent.trim();
        const xn = parseFloat(x), yn = parseFloat(y);
        if (!isNaN(xn) && !isNaN(yn)) { x = xn; y = yn; }
        if (x < y) return -1*dir;
        if (x > y) return 1*dir;
        return 0;
      });
      rows.forEach(r => tbody.appendChild(r));

      // æ›´æ–°æ’åºæŒ‡ç¤º
      thead.querySelectorAll(".sort-ind").forEach(s => s.textContent = "");
      thEl.querySelector(".sort-ind").textContent = dir === 1 ? "â–²" : "â–¼";
    }
  },
  error: (err) => {
    document.getElementById("status").textContent = "âŒ è¼‰å…¥å¤±æ•—ï¼š" + (err?.message || err);
  }
});
</script>
</body>
</html>
